#!/usr/bin/env bash
set -euo pipefail

{{- if and (ne .chezmoi.os "linux") (ne .chezmoi.os "darwin") }}
echo "safe: only supported on linux and darwin (chezmoi os={{ .chezmoi.os }})" >&2
exit 1
{{- else }}

expand_tilde() {
  local p="$1"
  if [[ "$p" == "~" ]]; then
    printf '%s\n' "$HOME"
  elif [[ "$p" == "~/"* ]]; then
    printf '%s\n' "$HOME/${p:2}"
  else
    printf '%s\n' "$p"
  fi
}

realpath_safely() {
  # Portable realpath using POSIX cd/pwd for existing paths
  local target="$1"
  if [[ -d "$target" ]]; then
    (cd "$target" && pwd -P)
  elif [[ -f "$target" ]]; then
    local dir base
    dir="$(dirname "$target")"
    base="$(basename "$target")"
    printf '%s/%s\n' "$(cd "$dir" && pwd -P)" "$base"
  else
    # Non-existent: try realpath -m (GNU), then realpath (BSD), then return as-is
    realpath -m "$target" 2>/dev/null || realpath "$target" 2>/dev/null || printf '%s\n' "$target"
  fi
}

main() {
  # --- Workspace directory policy (from chezmoi data) ---
  local WORKSPACE_DIRS=(
{{- range .workspace_dirs }}
    {{ . | quote }}
{{- end }}
    {{ .chezmoi.sourceDir | quote }}
  )

  local pwd_real home_real in_workspace_dir d d_expanded d_real reply
  pwd_real="$(realpath_safely "$PWD")"
  home_real="$(realpath_safely "$HOME")"

  in_workspace_dir="0"
  for d in "${WORKSPACE_DIRS[@]}"; do
    d_expanded="$(expand_tilde "$d")"
    d_real="$(realpath_safely "$d_expanded")"
    if [[ "$pwd_real" == "$d_real" || "$pwd_real" == "$d_real/"* ]]; then
      in_workspace_dir="1"
      break
    fi
  done

  if [[ "$in_workspace_dir" != "1" ]]; then
    if [[ "$pwd_real" == "$home_real" || "$pwd_real" == "$home_real/"* ]]; then
      # Prompt when running under $HOME but not in workspace_dirs
      if [[ -t 0 ]]; then
        reply=""
        read -r -p "safe: '$PWD' is under \$HOME but not in workspace_dirs. Continue? [y/N] " reply
        if [[ "$reply" != "y" ]]; then
          echo "safe: aborted" >&2
          exit 1
        fi
      else
        echo "safe: refusing to run under \$HOME without tty confirmation" >&2
        exit 1
      fi
    else
      echo "safe: refusing to run outside workspace_dirs (PWD='$PWD')" >&2
      exit 1
    fi
  fi

  # --- Common variables used by both sandboxes ---
  local UID_NUM USER_NAME
  UID_NUM="$(id -u)"
  USER_NAME="$(id -un)"

  # Read-write paths (used by both sandboxes)
  local SAFE_RW_PATHS=(
    "$PWD"
    "$HOME/.cache"
    "$HOME/.opencode"
    "$HOME/.cache/opencode"
    "$HOME/.local/share/opencode"
    "$HOME/.local/state/opencode"
    "$HOME/.config/opencode"
  )

  # Read-only paths (used by both sandboxes)
  local SAFE_RO_PATHS=(
    "$HOME/.gitconfig"
    "$HOME/.config/git"
  )

  # Build environment arrays for both sandboxes
  # ENV_PAIRS: "KEY=VALUE" format for env -i (darwin)
  # BWRAP_ENV: --setenv KEY VALUE format for bwrap (linux)
  local ENV_PAIRS=()
  local BWRAP_ENV=()

  add_env() {
    local key="$1" val="$2"
    ENV_PAIRS+=( "$key=$val" )
    BWRAP_ENV+=( --setenv "$key" "$val" )
  }

  # Core environment
  add_env HOME "$HOME"
  add_env USER "$USER_NAME"
  add_env LOGNAME "$USER_NAME"
  add_env TMPDIR /tmp
  add_env PWD "$PWD"
  add_env XDG_CONFIG_HOME "$HOME/.config"
  add_env XDG_CACHE_HOME "$HOME/.cache"
  add_env XDG_STATE_HOME "$HOME/.local/state"
  add_env XDG_DATA_HOME "$HOME/.local/share"
{{- if eq .chezmoi.os "linux" }}
  add_env XDG_RUNTIME_DIR "/run/user/$UID_NUM"
{{- end }}

  # Optional passthrough env vars
  local k
  for k in TERM LANG LANGUAGE EDITOR VISUAL PATH; do
    if [[ -n "${!k-}" ]]; then
      add_env "$k" "${!k}"
    fi
  done

  # --- Set terminal title to command name ---
  local cmd_name
  cmd_name="$(basename "$1")"
  if [[ -t 1 ]]; then
    printf '\033]0;%s\007' "$cmd_name"
  fi

{{- if eq .chezmoi.os "linux" }}
  # --- Bubblewrap sandbox (Linux) ---
  local BWRAP_BIND_ARGS=()
  local p

  # Add read-write binds
  for p in "${SAFE_RW_PATHS[@]}"; do
    if [[ -e "$p" ]]; then
      BWRAP_BIND_ARGS+=( --bind "$p" "$p" )
    fi
  done

  # Add read-only binds
  for p in "${SAFE_RO_PATHS[@]}"; do
    if [[ -e "$p" ]]; then
      BWRAP_BIND_ARGS+=( --ro-bind "$p" "$p" )
    fi
  done

  bwrap \
    --unshare-all \
    --share-net \
    --die-with-parent \
    --new-session \
    \
    `# Environment (strict allowlist)` \
    --clearenv \
    "${BWRAP_ENV[@]}" \
    \
    `# Basic filesystem (read-only system)` \
    --ro-bind /usr /usr \
    --ro-bind /lib /lib \
    --ro-bind-try /lib64 /lib64 \
    --ro-bind /bin /bin \
    --ro-bind /sbin /sbin \
    \
    `# proc/dev` \
    --proc /proc \
    --dev /dev \
    \
    `# tmp and runtime` \
    --perms 1777 --tmpfs /tmp \
    --perms 0755 --tmpfs /run \
    --dir /run/user \
    --perms 0700 --dir "/run/user/$UID_NUM" \
    --dir /var \
    --perms 1777 --tmpfs /var/tmp \
    --symlink /run /var/run \
    \
    `# SSL and certs` \
    --ro-bind-try /etc/ssl /etc/ssl \
    --ro-bind-try /etc/ca-certificates /etc/ca-certificates \
    --ro-bind-try /etc/pki /etc/pki \
    \
    `# DNS + identity resolution` \
    --ro-bind-try /etc/resolv.conf /etc/resolv.conf \
    --ro-bind-try /etc/hosts /etc/hosts \
    --ro-bind-try /etc/nsswitch.conf /etc/nsswitch.conf \
    --ro-bind-try /etc/passwd /etc/passwd \
    --ro-bind-try /etc/group /etc/group \
    --ro-bind-try /etc/localtime /etc/localtime \
    --ro-bind-try /etc/timezone /etc/timezone \
    --ro-bind-try /etc/alternatives /etc/alternatives \
    \
    `# Home (create empty, then bind allowed paths)` \
    --perms 0700 --dir "$HOME" \
    "${BWRAP_BIND_ARGS[@]}" \
    \
    --chdir "$PWD" \
    \
    `# Run command` \
    -- "$@"
{{- else if eq .chezmoi.os "darwin" }}
  # --- sandbox-exec sandbox (macOS) ---
  local profile p

  # Build sandbox profile
  profile='(version 1)
(deny default)

;; Allow process operations
(allow process-exec)
(allow process-fork)
(allow signal)

;; Allow network access
(allow network*)

;; Allow sysctl reads (needed for many programs)
(allow sysctl-read)

;; Allow mach lookups (IPC)
(allow mach-lookup)

;; Allow pseudo-terminal operations (needed for TUI apps)
(allow pseudo-tty)

;; Allow ioctl on terminal devices and standard file descriptors
(allow file-ioctl
  (literal "/dev/tty")
  (literal "/dev/null")
  (literal "/dev/zero")
  (literal "/dev/random")
  (literal "/dev/urandom")
  (regex #"^/dev/ttys[0-9]+$")
  (regex #"^/dev/fd/[0-9]+$")
)

;; System read-only paths
(allow file-read*
  (subpath "/System")
  (subpath "/usr")
  (subpath "/bin")
  (subpath "/sbin")
  (subpath "/Library")
  (subpath "/Applications")
  (subpath "/private/etc")
  (subpath "/private/var/db")
  (subpath "/dev")
  (literal "/")
  (subpath "/var")
  (subpath "/etc")
  (subpath "/tmp")
  (subpath "/private/tmp")
)

;; Device write access (for pty allocation and /dev/null etc.)
(allow file-write*
  (literal "/dev/null")
  (literal "/dev/zero")
  (literal "/dev/random")
  (literal "/dev/urandom")
  (literal "/dev/tty")
  (regex #"^/dev/ttys[0-9]+$")
  (regex #"^/dev/pty[a-z][0-9a-f]+$")
)

;; Temp directories (read-write)
(allow file-read* file-write*
  (subpath "/tmp")
  (subpath "/private/tmp")
  (subpath "/var/folders")
  (subpath "/private/var/folders")
)
'

  # Add read-write paths to profile
  for p in "${SAFE_RW_PATHS[@]}"; do
    if [[ -e "$p" ]]; then
      profile+="
(allow file-read* file-write* (subpath \"$p\"))"
    fi
  done

  # Add read-only paths to profile
  for p in "${SAFE_RO_PATHS[@]}"; do
    if [[ -e "$p" ]]; then
      profile+="
(allow file-read* (subpath \"$p\"))"
    fi
  done

  # Execute with sandbox
  /usr/bin/sandbox-exec -p "$profile" /usr/bin/env -i "${ENV_PAIRS[@]}" "$@"
{{- end }}
}
{{- end }}

main "$@"
